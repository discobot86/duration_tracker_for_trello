<script src="https://p.trellocdn.com/power-up.min.js"></script>
<script>
  // Define our key for storing the data
  var DATA_KEY = 'estimated-time';

  window.TrelloPowerUp.initialize({
    'card-badge': function(t, options) {
      // This function gets the stored data for the card
      return t.get('card', 'shared', DATA_KEY)
        .then(function(savedTime) {
          // and if a time is stored, it returns the badge object
          if (savedTime && typeof savedTime === 'number' && savedTime > 0) {
            return {
              text: savedTime + ' hrs',
              icon: 'https://discobot86.github.io/duration_tracker_for_trello/icon.png',
              color: 'blue',
              // THIS IS THE CRUCIAL FIX:
              // It tells Trello this is a dynamic badge and how often to check for updates.
              refresh: 10 
            };
          } else {
            // Otherwise, it returns nothing, so no badge is shown
            return null;
          }
        });
    },
    'card-back-section': function(t, options) {
      // This part is already correct
      return {
        title: 'Estimated Time (hrs)',
        icon: 'https://discobot86.github.io/duration_tracker_for_trello/icon.png',
        content: {
          type: 'iframe',
          url: t.signUrl('./index.html'),
        }
      };
    }
  });
</script>
